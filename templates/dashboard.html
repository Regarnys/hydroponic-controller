<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hydroponic Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<div class="container py-3">
  <h1>Hydroponic Dashboard</h1>

  {% if message %}
  <div class="alert alert-info">{{ message }}</div>
  {% endif %}

  <!-- Nav Tabs -->
  <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">Overview</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button">Manual Pump</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="calibrate-tab" data-bs-toggle="tab" data-bs-target="#calibrate" type="button">Calibrate</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button">Config</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" type="button">Events</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button">Usage Summary</button>
    </li>
  </ul>

  <div class="tab-content mt-3">

    <!-- OVERVIEW TAB -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
      <h2>pH & EC Charts (last 20 points)</h2>
      <canvas id="phChart" width="400" height="200"></canvas>
      <canvas id="ecChart" width="400" height="200"></canvas>

      <script>
        let phData = {{ ph_data|tojson }};
        let ecData = {{ ec_data|tojson }};

        let phLabels = phData.map(d => d[0]);
        let phValues = phData.map(d => d[1]);
        let ecLabels = ecData.map(d => d[0]);
        let ecValues = ecData.map(d => d[1]);

        let phCtx = document.getElementById("phChart").getContext('2d');
        new Chart(phCtx, {
          type: 'line',
          data: {
            labels: phLabels,
            datasets: [{
              label: 'pH',
              data: phValues,
              borderColor: 'blue',
              fill: false
            }]
          }
        });

        let ecCtx = document.getElementById("ecChart").getContext('2d');
        new Chart(ecCtx, {
          type: 'line',
          data: {
            labels: ecLabels,
            datasets: [{
              label: 'EC',
              data: ecValues,
              borderColor: 'green',
              fill: false
            }]
          }
        });
      </script>

      <h3>Auto Dosing Test</h3>
      <form method="POST">
        <input type="hidden" name="action" value="auto_dosing_test">
        <button class="btn btn-warning">Read &amp; Log Sensors + Basic Dosing Logic</button>
      </form>
    </div>

    <!-- MANUAL PUMP TAB -->
    <div class="tab-pane fade" id="manual" role="tabpanel" aria-labelledby="manual-tab">
      <h2>Manual Pump Control</h2>
      <form method="POST" class="mb-3">
        <input type="hidden" name="action" value="manual_pump">
        <label>Pump:</label>
        <select name="pump_name" class="form-select w-auto d-inline">
          <option>pH_up</option>
          <option>pH_down</option>
          <option>nutrientA</option>
          <option>nutrientB</option>
          <option>nutrientC</option>
        </select>
        <label>Seconds:</label>
        <input type="text" name="run_seconds" value="5" class="form-control d-inline w-auto">
        <button class="btn btn-primary">Run Pump</button>
      </form>

      <h3>Volume-based Dosing</h3>
      <form method="POST">
        <input type="hidden" name="action" value="volume_dose">
        <label>Pump:</label>
        <select name="pump_name" class="form-select w-auto d-inline">
          <option>pH_up</option>
          <option>pH_down</option>
          <option>nutrientA</option>
          <option>nutrientB</option>
          <option>nutrientC</option>
        </select>
        <label>Volume (mL):</label>
        <input type="text" name="ml_amount" value="10" class="form-control d-inline w-auto">
        <button class="btn btn-success">Dose Volume</button>
      </form>
    </div>

    <!-- CALIBRATE TAB -->
    <div class="tab-pane fade" id="calibrate" role="tabpanel" aria-labelledby="calibrate-tab">
      <h2>Calibrate Pumps</h2>
      <p>Step 1: Run the pump for X seconds. Step 2: Measure volume. Step 3: Save calibration.</p>

      <h3>Test Run</h3>
      <form method="POST">
        <input type="hidden" name="action" value="cal_test_run">
        <label>Pump:</label>
        <select name="pump_name">
          <option>pH_up</option>
          <option>pH_down</option>
          <option>nutrientA</option>
          <option>nutrientB</option>
          <option>nutrientC</option>
        </select>
        <label>Seconds:</label>
        <input type="text" name="cal_test_seconds" value="5">
        <button class="btn btn-primary">Run Pump</button>
      </form>

      <h3>Save Measured Volume</h3>
      <form method="POST">
        <input type="hidden" name="action" value="cal_save">
        <label>Pump:</label>
        <select name="pump_name">
          <option>pH_up</option>
          <option>pH_down</option>
          <option>nutrientA</option>
          <option>nutrientB</option>
          <option>nutrientC</option>
        </select>
        <label>Seconds (same used above):</label>
        <input type="text" name="cal_test_seconds" value="5">
        <label>Measured mL:</label>
        <input type="text" name="measured_ml" value="0">
        <button class="btn btn-success">Save Calibration</button>
      </form>

      <h3>Current Calibration</h3>
      <pre>{{ config["pump_calibration"]|tojson }}</pre>
    </div>

    <!-- CONFIG TAB -->
    <div class="tab-pane fade" id="config" role="tabpanel" aria-labelledby="config-tab">
      <h2>System Config</h2>
      <form method="POST">
        <input type="hidden" name="action" value="update_config">
        <label>pH Min:</label>
  

