<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hydroponic Dashboard</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .chart-canvas {
      max-width: 100%;
      height: 400px;
    }
    .small-chart {
      height: 200px !important;
    }
    .usage-canvas {
      max-width: 100%;
      height: 300px;
    }
    .camera-feed {
      width: 100%;
      max-height: 480px;
      object-fit: contain;
    }
    .snapshot-thumbnail {
      width: 100px;
      height: 100px;
      object-fit: cover;
      margin: 5px;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-3">
  <h1 class="mb-4">Hydroponic Dashboard</h1>

  {% if message %}
    <div class="alert alert-info">{{ message }}</div>
  {% endif %}

  <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="livedata-tab" data-bs-toggle="tab"
              data-bs-target="#livedata" type="button" role="tab"
              aria-controls="livedata" aria-selected="true">
        Live Data
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="camera-tab" data-bs-toggle="tab"
              data-bs-target="#camera" type="button" role="tab"
              aria-controls="camera" aria-selected="false">
        Camera
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="insights-tab" data-bs-toggle="tab"
              data-bs-target="#insights" type="button" role="tab"
              aria-controls="insights" aria-selected="false">
        Insights
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pumpcontrol-tab" data-bs-toggle="tab"
              data-bs-target="#pumpcontrol" type="button" role="tab"
              aria-controls="pumpcontrol" aria-selected="false">
        Pump Control
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="events-tab" data-bs-toggle="tab"
              data-bs-target="#events" type="button" role="tab"
              aria-controls="events" aria-selected="false">
        Events
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="usage-tab" data-bs-toggle="tab"
              data-bs-target="#usage" type="button" role="tab"
              aria-controls="usage" aria-selected="false">
        Usage
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="config-tab" data-bs-toggle="tab"
              data-bs-target="#config" type="button" role="tab"
              aria-controls="config" aria-selected="false">
        Config
      </button>
    </li>
  </ul>

  <div class="tab-content mt-3" id="dashboardTabsContent">
    <!-- LIVE DATA TAB -->
    <div class="tab-pane fade show active" id="livedata" role="tabpanel" aria-labelledby="livedata-tab">
      <h2>pH & EC Charts (last 20 points)</h2>
      <div class="row">
        <div class="col-md-6">
          <canvas id="phChart" class="chart-canvas"></canvas>
        </div>
        <div class="col-md-6">
          <canvas id="ecChart" class="chart-canvas"></canvas>
        </div>
      </div>

      <h3 class="mt-4">Auto Dosing Test</h3>
      <form method="POST">
        <input type="hidden" name="action" value="auto_dosing_test">
        <button class="btn btn-warning">Read & Log Sensors + Basic Dosing Logic</button>
      </form>
    </div>

    <!-- CAMERA TAB -->
    <div class="tab-pane fade" id="camera" role="tabpanel" aria-labelledby="camera-tab">
      <div class="row mt-3">
        <!-- Live Feed -->
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title">Live Plant Camera</h5>
            </div>
            <div class="card-body">
              <img src="{{ url_for('video_feed') }}" class="camera-feed rounded">
            </div>
            <div class="card-footer">
              <button class="btn btn-primary" onclick="takeSnapshot()">Take Snapshot</button>
              <button class="btn btn-secondary" id="timelapseBtn" onclick="toggleTimelapse()">
                Start Timelapse
              </button>
            </div>
          </div>
        </div>

        <!-- Recent Snapshots -->
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title">Recent Snapshots</h5>
            </div>
            <div class="card-body">
              <div id="snapshots-list" class="list-group">
                <!-- Snapshots will be loaded here -->
              </div>
            </div>
          </div>

          <!-- Plant Analysis -->
          <div class="card mt-3">
            <div class="card-header">
              <h5 class="card-title">Plant Analysis</h5>
            </div>
            <div class="card-body">
              <div id="plant-health-data">
                <p>Green Coverage: <span id="green-percent">--</span>%</p>
                <p>Last Analysis: <span id="last-analysis">Never</span></p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Automation Settings -->
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="card-title">Automation Settings</h5>
        </div>
        <div class="card-body">
          <form id="automation-settings-form">
            <!-- Image Capture Schedule -->
            <div class="mb-3">
              <label class="form-label">Image Capture Interval (minutes)</label>
              <input type="number" class="form-control" id="image-capture-interval" 
                     min="1" max="1440" value="60">
            </div>

            <!-- Timelapse Settings -->
            <div class="mb-3">
              <label class="form-label">Timelapse Settings</label>
              <div class="input-group">
                <input type="number" class="form-control" id="timelapse-interval" 
                       placeholder="Interval (minutes)" value="60">
                <input type="number" class="form-control" id="timelapse-duration" 
                       placeholder="Duration (hours)" value="24">
              </div>
            </div>

            <!-- Plant Health Monitoring -->
            <div class="mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="health-monitoring-enabled">
                <label class="form-check-label">Enable Plant Health Monitoring</label>
              </div>
              <div class="input-group mt-2">
                <span class="input-group-text">Alert if green coverage below</span>
                <input type="number" class="form-control" id="min-green-percent" 
                       value="30" min="0" max="100">
                <span class="input-group-text">%</span>
              </div>
            </div>

            <button type="submit" class="btn btn-primary">Save Settings</button>
          </form>
        </div>
      </div>
    </div>

    <!-- INSIGHTS TAB -->
    <div class="tab-pane fade" id="insights" role="tabpanel" aria-labelledby="insights-tab">
      <h2>System Insights</h2>
      <div class="row">
        <!-- Card 1: Today's pH Range -->
        <div class="col-md-4 mb-3">
          <div class="card text-bg-light shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Today's pH Range</h5>
              {% if daily_pH_min is not none and daily_pH_max is not none %}
                <p class="card-text">
                  Min: {{ "%.2f"|format(daily_pH_min) }}<br>
                  Max: {{ "%.2f"|format(daily_pH_max) }}
                </p>
              {% else %}
                <p class="card-text">No pH data for today</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Card 2: Pump Usage Today -->
        <div class="col-md-4 mb-3">
          <div class="card text-bg-light shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Pump Usage Today</h5>
              <p class="card-text">{{ "%.1f"|format(daily_pump_usage) }} seconds</p>
            </div>
          </div>
        </div>

        <!-- Card 3: Plant Health -->
        <div class="col-md-4 mb-3">
          <div class="card text-bg-light shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Plant Health</h5>
              <p class="card-text" id="plant-health-card">Analyzing...</p>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-4">

      <h3>Pump Usage by Day</h3>
      <div style="width: 100%; height: 250px;">
        <canvas id="pumpUsageChart" class="small-chart"></canvas>
      </div>

      <hr class="my-4">

      <h3>Recent Interesting Events</h3>
      {% if interesting_events %}
        <ul class="list-group">
        {% for ev in interesting_events %}
          <li class="list-group-item">
            <small class="text-muted">{{ ev[0] }}</small><br>
            <strong>{{ ev[1] }}:</strong> {{ ev[2] }}
          </li>
        {% endfor %}
        </ul>
      {% else %}
        <p>No interesting events found.</p>
      {% endif %}
    </div>

    <!-- Your existing PUMP CONTROL, EVENTS, USAGE, and CONFIG tabs remain the same -->
    <!-- Keep all your existing tabs here -->

  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Charts and Data Processing -->
<script>
// Your existing chart initialization code
let phData = {{ ph_data|tojson }};
let ecData = {{ ec_data|tojson }};

let phLabels = phData.map(d => d[0]);
let phValues = phData.map(d => d[1]);
let ecLabels = ecData.map(d => d[0]);
let ecValues = ecData.map(d => d[1]);

// pH Chart
let phCtx = document.getElementById("phChart").getContext('2d');
new Chart(phCtx, {
    type: 'line',
    data: {
        labels: phLabels,
        datasets: [{
            label: "pH",
            data: phValues,
            borderColor: 'blue',
            fill: false
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

// EC Chart
let ecCtx = document.getElementById("ecChart").getContext('2d');
new Chart(ecCtx, {
    type: 'line',
    data: {
        labels: ecLabels,
        datasets: [{
            label: "EC",
            data: ecValues,
            borderColor: 'green',
            fill: false
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

// Pump Usage Chart
let usageData = {{ usage_bar_data|tojson }};
let pumpNames = {{ all_pumps|tojson }};

let usageLabels = usageData.map(d => d.date);
let colors = ["#3e95cd","#8e5ea2","#3cba9f","#e8c3b9","#c45850","#d5a3bb","#a7c2d2","#db5963"];

let datasets = pumpNames.map((pump, idx) => {
    return {
        label: pump,
        data: usageData.map(dayObj => dayObj[pump] || 0),
        backgroundColor: colors[idx % colors.length],
        stack: "pumpStack"
    };
});

new Chart(document.getElementById("pumpUsageChart"), {
    type: 'bar',
    data: {
        labels: usageLabels,
        datasets: datasets
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { stacked: true },
            y: { stacked: true }
        }
    }
});

// Camera and Automation Controls
function takeSnapshot() {
    fetch('/take_snapshot', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                loadRecentSnapshots();
                alert('Snapshot taken!');
            } else {
                alert('Error taking snapshot: ' + data.message);
            }
        })
        .catch(error => alert('Error: ' + error));
}

function loadRecentSnapshots() {
    fetch('/snapshots')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const list = document.getElementById('snapshots-list');
                list.innerHTML = '';
                data.snapshots.forEach(snapshot => {
                    const item = document.createElement('a');
                    item.href = `/snapshots/${snapshot}`;
                    item.className = 'list-group-item list-group-item-action';
                    item.textContent = snapshot;
                    list.appendChild(item);
                });
            }
        });
}

let timelapseActive = false;
function toggleTimelapse() {
    const btn = document.getElementById('timelapseBtn');
    if (!timelapseActive) {
        fetch('/automation/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                'schedules': {
                    'timelapse': {
                        'enabled': true,
                        'interval_minutes': parseInt(document.getElementById('timelapse-interval').value),
                        'duration_hours': parseInt(document.getElementById('timelapse-duration').value)
                    }
                }
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                timelapseActive = true;
                btn.textContent = 'Stop Timelapse';
                btn.classList.replace('btn-secondary', 'btn-danger');
            }
        });
    } else {
        fetch('/automation/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                'schedules': {
                    'timelapse': {
                        'enabled': false
                    }
                }
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                timelapseActive = false;
                btn.textContent = 'Start Timelapse';
                btn.classList.replace('btn-danger', 'btn-secondary');
            }
        });
    }
}

// Load initial data and start periodic updates
document.addEventListener('DOMContentLoaded', function() {
    loadRecentSnapshots();
    
    // Load automation settings
    fetch('/automation/status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const config = data.config;
                document.getElementById('image-capture-interval').value = 
                    config.schedules.image_capture.interval_minutes;
                document.getElementById('health-monitoring-enabled').checked = 
                    config.triggers.plant_health.enabled;
                document.getElementById('min-green-percent').value = 
                    config.triggers.plant_health.thresholds.min_green_percent;
            }
        });

    // Update plant health periodically
    function updatePlantHealth() {
        const healthCard = document.getElementById('plant-health-card');
        const greenPercent = document.getElementById('green-percent');
        const lastAnalysis = document.getElementById('last-analysis');
        
        fetch('/automation/status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.plant_health) {
                    const health = data.plant_health;
                    greenPercent.textContent = health.green_percentage.toFixed(1);
                    lastAnalysis.textContent = new Date(health.timestamp).toLocaleString();
                    
                    // Update health card in insights tab
                    const coverage = health.green_percentage;
                    let status = 'Good';
                    let color = 'text-success';
                    
                    if (coverage < 30) {
                        status = 'Poor';
                        color = 'text-danger';
                    } else if (coverage < 60) {
                        status = 'Fair';
                        color = 'text-warning';
                    }
                    
                    healthCard.innerHTML = `
                        <p class="${color}">Status: ${status}</p>
                        <p>Green Coverage: ${coverage.toFixed(1)}%</p>
                        <small class="text-muted">Updated: ${new Date(health.timestamp).toLocaleString()}</small>
                    `;
                }
            });
    }

    // Update every 5 minutes
    updatePlantHealth();
    setInterval(updatePlantHealth, 5 * 60 * 1000);
});

// Save automation settings
document.getElementById('automation-settings-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const config = {
        schedules: {
            image_capture: {
                enabled: true,
                interval_minutes: parseInt(document.getElementById('image-capture-interval').value)
            }
        },
        triggers: {
            plant_health: {
                enabled: document.getElementById('health-monitoring-enabled').checked,
                thresholds: {
                    min_green_percent: parseInt(document.getElementById('min-green-percent').value)
                }
            }
        }
    };
    
    fetch('/automation/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Settings saved successfully!');
        } else {
            alert('Error saving settings: ' + data.message);
        }
    });
});
</script>
</body>
</html>


