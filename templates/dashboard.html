<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hydroponic Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>Hydroponic Dashboard</h1>

<!-- Possibly a nav bar with links to calibrate, config, etc. -->
<p>
  <a href="{{ url_for('config') }}">Config</a> |
  <a href="{{ url_for('calibrate_pump') }}">Calibrate</a> |
  ...
</p>

<!-- pH and EC charts using ph_data, ec_data from app.py -->
<h2>pH / EC Charts</h2>
<canvas id="phChart" width="400" height="200"></canvas>
<canvas id="ecChart" width="400" height="200"></canvas>

<script>
  let phData = {{ ph_data|tojson }};
  let ecData = {{ ec_data|tojson }};

  let phLabels = phData.map(d => d[0]);
  let phValues = phData.map(d => d[1]);
  let ecLabels = ecData.map(d => d[0]);
  let ecValues = ecData.map(d => d[1]);

  let phCtx = document.getElementById("phChart").getContext('2d');
  new Chart(phCtx, {
    type: 'line',
    data: {
      labels: phLabels,
      datasets: [{
        label: 'pH',
        data: phValues,
        borderColor: 'blue',
        fill: false
      }]
    }
  });

  let ecCtx = document.getElementById("ecChart").getContext('2d');
  new Chart(ecCtx, {
    type: 'line',
    data: {
      labels: ecLabels,
      datasets: [{
        label: 'EC',
        data: ecValues,
        borderColor: 'green',
        fill: false
      }]
    }
  });
</script>

<!-- Manual Pump form -->
<h2>Manual Pump Control</h2>
<form method="POST">
  <input type="hidden" name="action" value="manual_pump">
  <label>Pump:</label>
  <select name="pump_name">
    <option>pH_up</option>
    <option>pH_down</option>
    <option>nutrientA</option>
    <option>nutrientB</option>
    <option>nutrientC</option>
  </select>
  <label>Seconds:</label>
  <input type="text" name="run_seconds" value="5">
  <button>Run Pump</button>
</form>

<!-- Volume-based dosing form -->
<h2>Volume-based Dosing</h2>
<form method="POST">
  <input type="hidden" name="action" value="volume_dose">
  <label>Pump:</label>
  <select name="pump_name">
    <option>pH_up</option>
    <option>pH_down</option>
    <option>nutrientA</option>
    <option>nutrientB</option>
    <option>nutrientC</option>
  </select>
  <label>Volume (mL):</label>
  <input type="text" name="ml_amount" value="5">
  <button>Dose Volume</button>
</form>

<!-- Auto Dosing Test -->
<h2>Auto Dosing Test</h2>
<form method="POST">
  <input type="hidden" name="action" value="auto_dosing_test">
  <button>Read & Log Sensors + AutoDosing</button>
</form>

<!-- Events table / pagination -->
<h2>Events</h2>
{% if event_rows %}
  <table border="1">
    <tr><th>Timestamp</th><th>Event</th><th>Details</th></tr>
    {% for row in event_rows %}
    <tr>
      <td>{{ row[0] }}</td>
      <td>{{ row[1] }}</td>
      <td>{{ row[2] }}</td>
    </tr>
    {% endfor %}
  </table>
  <p>
  {% if has_prev_page %}
    <a href="{{ url_for('dashboard', page=current_page-1) }}">Prev</a>
  {% endif %}
  {% if has_next_page %}
    <a href="{{ url_for('dashboard', page=current_page+1) }}">Next</a>
  {% endif %}
  </p>
{% else %}
  <p>No events found</p>
{% endif %}

<!-- Summary usage aggregator -->
<h2>Summary Usage</h2>
{% if aggregated_data %}
  <table border="1">
    <tr>
      <th>Date</th>
      {% for p in all_pumps %}
      <th>{{ p }}</th>
      {% endfor %}
    </tr>
    {% for day_data in summary_list %}
      <tr>
        <td>{{ day_data.date }}</td>
        {% for p in all_pumps %}
          <td>{{ day_data.usage.get(p, 0) }}</td>
        {% endfor %}
      </tr>
    {% endfor %}
  </table>
{% else %}
  <p>No aggregator data yet.</p>
{% endif %}

</body>
</html>

