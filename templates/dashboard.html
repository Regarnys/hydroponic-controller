<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hydroponic Dashboard</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .chart-canvas {
      max-width: 100%;
      height: 400px;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-3">
  <h1 class="mb-4">Hydroponic Dashboard</h1>

  {% if message %}
    <div class="alert alert-info">{{ message }}</div>
  {% endif %}

  <!-- Nav Tabs -->
  <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="livedata-tab" data-bs-toggle="tab"
              data-bs-target="#livedata" type="button" role="tab"
              aria-controls="livedata" aria-selected="true">
        Live Data
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pumpcontrol-tab" data-bs-toggle="tab"
              data-bs-target="#pumpcontrol" type="button" role="tab"
              aria-controls="pumpcontrol" aria-selected="false">
        Pump Control
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="events-tab" data-bs-toggle="tab"
              data-bs-target="#events" type="button" role="tab"
              aria-controls="events" aria-selected="false">
        Events
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="usage-tab" data-bs-toggle="tab"
              data-bs-target="#usage" type="button" role="tab"
              aria-controls="usage" aria-selected="false">
        Usage
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="config-tab" data-bs-toggle="tab"
              data-bs-target="#config" type="button" role="tab"
              aria-controls="config" aria-selected="false">
        Config
      </button>
    </li>
  </ul>

  <div class="tab-content mt-3" id="dashboardTabsContent">

    <!-- LIVE DATA TAB -->
    <div class="tab-pane fade show active" id="livedata" role="tabpanel" aria-labelledby="livedata-tab">
      <h2>pH &amp; EC Charts (last 20 points)</h2>
      <div class="row">
        <div class="col-md-6">
          <canvas id="phChart" class="chart-canvas"></canvas>
        </div>
        <div class="col-md-6">
          <canvas id="ecChart" class="chart-canvas"></canvas>
        </div>
      </div>
      <script>
        let phData = {{ ph_data|tojson }};
        let ecData = {{ ec_data|tojson }};

        let phLabels = phData.map(d => d[0]);
        let phValues = phData.map(d => d[1]);
        let ecLabels = ecData.map(d => d[0]);
        let ecValues = ecData.map(d => d[1]);

        // pH Chart
        let phCtx = document.getElementById("phChart").getContext('2d');
        new Chart(phCtx, {
          type: 'line',
          data: {
            labels: phLabels,
            datasets: [{
              label: "pH",
              data: phValues,
              borderColor: 'blue',
              fill: false
            }]
          }
        });

        // EC Chart
        let ecCtx = document.getElementById("ecChart").getContext('2d');
        new Chart(ecCtx, {
          type: 'line',
          data: {
            labels: ecLabels,
            datasets: [{
              label: "EC",
              data: ecValues,
              borderColor: 'green',
              fill: false
            }]
          }
        });
      </script>

      <h3 class="mt-4">Auto Dosing Test</h3>
      <form method="POST">
        <input type="hidden" name="action" value="auto_dosing_test">
        <button class="btn btn-warning">Read &amp; Log Sensors + Basic Dosing Logic</button>
      </form>
    </div>

    <!-- PUMP CONTROL TAB -->
<div class="tab-pane fade" id="pumpcontrol" role="tabpanel" aria-labelledby="pumpcontrol-tab">
  <h2>Pump Control</h2>
  <p>Manually run pumps or calibrate them below.</p>

  <div class="row">
    <!-- Left Column: Manual Pump Control -->
    <div class="col-md-6 mb-3">
      <h3>Manual Pump (Seconds)</h3>
      <form method="POST">
        <input type="hidden" name="action" value="manual_pump">
        <div class="mb-2">
          <label for="pump_name" class="form-label">Pump:</label>
          <select name="pump_name" id="pump_name" class="form-select w-auto d-inline">
            <option>pH_up</option>
            <option>pH_down</option>
            <option>nutrientA</option>
            <option>nutrientB</option>
            <option>nutrientC</option>
          </select>
        </div>
        <div class="mb-2">
          <label for="run_seconds" class="form-label">Seconds:</label>
          <input type="text" name="run_seconds" id="run_seconds"
                 value="5" class="form-control w-auto d-inline">
        </div>
        <button class="btn btn-primary">Run Pump</button>
      </form>
    </div>

    <!-- Right Column: Volume-based Dosing -->
    <div class="col-md-6 mb-3">
      <h3>Volume-based Dosing</h3>
      <form method="POST">
        <input type="hidden" name="action" value="volume_dose">
        <div class="mb-2">
          <label class="form-label">Pump:</label>
          <select name="pump_name" class="form-select w-auto d-inline">
            <option>pH_up</option>
            <option>pH_down</option>
            <option>nutrientA</option>
            <option>nutrientB</option>
            <option>nutrientC</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Volume (mL):</label>
          <input type="text" name="ml_amount" value="10"
                 class="form-control w-auto d-inline">
        </div>
        <button class="btn btn-success">Dose Volume</button>
      </form>
    </div>
  </div><!-- row -->

  <hr class="my-4">

  <div class="row">
    <!-- Left Column: Calibration Test Run -->
    <div class="col-md-6 mb-3">
      <h3>Calibration: Test Run</h3>
      <form method="POST">
        <input type="hidden" name="action" value="cal_test_run">
        <div class="mb-2">
          <label class="form-label">Pump:</label>
          <select name="pump_name" class="form-select w-auto d-inline">
            <option>pH_up</option>
            <option>pH_down</option>
            <option>nutrientA</option>
            <option>nutrientB</option>
            <option>nutrientC</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Seconds:</label>
          <input type="text" name="cal_test_seconds" value="5"
                 class="form-control w-auto d-inline">
        </div>
        <button class="btn btn-secondary">Run Pump</button>
      </form>
    </div>

    <!-- Right Column: Save Measured Volume -->
    <div class="col-md-6 mb-3">
      <h3>Calibration: Save Measurement</h3>
      <form method="POST">
        <input type="hidden" name="action" value="cal_save">
        <div class="mb-2">
          <label class="form-label">Pump:</label>
          <select name="pump_name" class="form-select w-auto d-inline">
            <option>pH_up</option>
            <option>pH_down</option>
            <option>nutrientA</option>
            <option>nutrientB</option>
            <option>nutrientC</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Seconds (same used above):</label>
          <input type="text" name="cal_test_seconds" value="5"
                 class="form-control w-auto d-inline">
        </div>
        <div class="mb-2">
          <label class="form-label">Measured mL:</label>
          <input type="text" name="measured_ml" value="0"
                 class="form-control w-auto d-inline">
        </div>
        <button class="btn btn-info">Save Calibration</button>
      </form>

      <h5 class="mt-3">Current Calibration</h5>
      <pre>{{ config["pump_calibration"]|tojson }}</pre>
    </div>
  </div><!-- row -->
</div><!-- end Pump Control tab -->


      <h3>Volume-based Dosing</h3>
      <form method="POST">
        <input type="hidden" name="action" value="volume_dose">
        <div class="mb-2">
          <label>Pump:</label>
          <select name="pump_name" class="form-select w-auto d-inline">
            <option>pH_up</option>
            <option>pH_down</option>
            <option>nutrientA</option>
            <option>nutrientB</option>
            <option>nutrientC</option>
          </select>
        </div>
        <div class="mb-2">
          <label>Volume (mL):</label>
          <input type="text" name="ml_amount" value="10" class="form-control w-auto d-inline">
        </div>
        <button class="btn btn-success">Dose Volume</button>
      </form>

      <hr class="my-4">

      <h3>Calibration</h3>
      <p>Step 1: Run pump for X seconds, measure volume. Step 2: Save calibration.</p>

      <h4>Test Run</h4>
      <form method="POST" class="mb-3">
        <input type="hidden" name="action" value="cal_test_run">
        <div class="mb-2">
          <label>Pump:</label>
          <select name="pump_name" class="form-select w-auto d-inline">
            <option>pH_up</option>
            <option>pH_down</option>
            <option>nutrientA</option>
            <option>nutrientB</option>
            <option>nutrientC</option>
          </select>
        </div>
        <div class="mb-2">
          <label>Seconds:</label>
          <input type="text" name="cal_test_seconds" value="5" class="form-control w-auto d-inline">
        </div>
        <button class="btn btn-secondary">Run Pump</button>
      </form>

      <h4>Save Measured Volume</h4>
      <form method="POST">
        <input type="hidden" name="action" value="cal_save">
        <div class="mb-2">
          <label>Pump:</label>
          <select name="pump_name" class="form-select w-auto d-inline">
            <option>pH_up</option>
            <option>pH_down</option>
            <option>nutrientA</option>
            <option>nutrientB</option>
            <option>nutrientC</option>
          </select>
        </div>
        <div class="mb-2">
          <label>Seconds (same used above):</label>
          <input type="text" name="cal_test_seconds" value="5" class="form-control w-auto d-inline">
        </div>
        <div class="mb-2">
          <label>Measured mL:</label>
          <input type="text" name="measured_ml" value="0" class="form-control w-auto d-inline">
        </div>
        <button class="btn btn-info">Save Calibration</button>
      </form>

      <h5 class="mt-3">Current Calibration</h5>
      <pre>{{ config["pump_calibration"]|tojson }}</pre>

    </div>

    <!-- EVENTS TAB -->
    <div class="tab-pane fade" id="events" role="tabpanel" aria-labelledby="events-tab">
      <h2>Recent Events</h2>
      {% if event_rows %}
        <table class="table table-striped">
          <thead>
            <tr><th>Timestamp</th><th>Event</th><th>Details</th></tr>
          </thead>
          <tbody>
            {% for row in event_rows %}
            <tr>
              <td>{{ row[0] }}</td>
              <td>{{ row[1] }}</td>
              <td>{{ row[2] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <p>
        {% if has_prev_page %}
          <a href="{{ url_for('dashboard', page=(current_page-1)) }}">Prev</a>
        {% endif %}
        {% if has_next_page %}
          <a href="{{ url_for('dashboard', page=(current_page+1)) }}">Next</a>
        {% endif %}
        </p>
      {% else %}
        <p>No events found.</p>
      {% endif %}
    </div>

    <!-- USAGE TAB -->
    <div class="tab-pane fade" id="usage" role="tabpanel" aria-labelledby="usage-tab">
      <h2>Pump Usage Summary</h2>
      {% if summary_list %}
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Date</th>
              {% for p in all_pumps %}
                <th>{{ p }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for day_data in summary_list %}
            <tr>
              <td>{{ day_data.date }}</td>
              {% for p in all_pumps %}
                <td>{{ day_data.usage.get(p, 0) }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>No aggregator data yet.</p>
      {% endif %}
    </div>

    <!-- CONFIG TAB -->
    <div class="tab-pane fade" id="config" role="tabpanel" aria-labelledby="config-tab">
      <h2>System Config</h2>
      <form method="POST">
        <input type="hidden" name="action" value="update_config">
        <div class="mb-2">
          <label>pH Min:</label>
          <input type="text" name="ph_min" value="{{ config.ph_min }}">
        </div>
        <div class="mb-2">
          <label>pH Max:</label>
          <input type="text" name="ph_max" value="{{ config.ph_max }}">
        </div>
        <div class="mb-2">
          <label>EC Min:</label>
          <input type="text" name="ec_min" value="{{ config.ec_min }}">
        </div>
        <button class="btn btn-primary">Save</button>
      </form>
    </div>

  </div><!-- /.tab-content -->

</div><!-- /.container -->

<!-- Bootstrap JS bundle (enables tab switching) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>



