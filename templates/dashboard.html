<!-- File: templates/dashboard.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hydroponic Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
<div class="container py-3">

  <h1>Central Dashboard</h1>

  <!-- Nav Tabs -->
  <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">Overview</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" type="button">Events</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button">Manual Pump</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button">Config</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button">Summary</button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <!-- OVERVIEW TAB -->
    <div class="tab-pane fade show active" id="overview">
      <div class="row">
        <div class="col-md-6">
          <div class="card mb-3">
            <div class="card-header">pH Chart</div>
            <div class="card-body">
              <canvas id="phChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card mb-3">
            <div class="card-header">EC Chart</div>
            <div class="card-body">
              <canvas id="ecChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <!-- You can add a "Run Auto Dosing" button here if you want -->
      <form method="POST" action="{{ url_for('dashboard') }}">
        <input type="hidden" name="action" value="auto_dosing_test">
        <button class="btn btn-warning">Run Auto Dosing Test</button>
      </form>
    </div>

    <!-- EVENTS TAB -->
    <div class="tab-pane fade" id="events">
      <div class="card">
        <div class="card-header">Recent Events (raw logs)</div>
        <div class="card-body">
          {% if event_rows %}
            <table class="table table-striped">
              <thead><tr><th>Timestamp</th><th>Event</th><th>Details</th></tr></thead>
              <tbody>
                {% for row in event_rows %}
                  <tr>
                    <td>{{ row[0] }}</td>
                    <td>{{ row[1] }}</td>
                    <td>{{ row[2] }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p>No events found.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- MANUAL PUMP TAB -->
    <div class="tab-pane fade" id="manual">
      <div class="card">
        <div class="card-header">Manual Pump Control</div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('dashboard') }}">
            <input type="hidden" name="action" value="manual_pump">
            <div class="mb-3">
              <label for="pump_name" class="form-label">Pump:</label>
              <select name="pump_name" id="pump_name" class="form-select">
                <option>pH_up</option>
                <option>pH_down</option>
                <option>nutrientA</option>
                <option>nutrientB</option>
                <option>nutrientC</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="run_seconds" class="form-label">Seconds:</label>
              <input type="text" name="run_seconds" class="form-control">
            </div>
            <button type="submit" class="btn btn-primary">Run Pump</button>
          </form>
        </div>
      </div>
    </div>

    <!-- CONFIG TAB -->
    <div class="tab-pane fade" id="config">
      <div class="card">
        <div class="card-header">System Config</div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('dashboard') }}">
            <input type="hidden" name="action" value="update_config">
            <div class="mb-3">
              <label>pH Min:</label>
              <input type="text" name="ph_min" class="form-control" value="{{ config.ph_min }}">
            </div>
            <div class="mb-3">
              <label>pH Max:</label>
              <input type="text" name="ph_max" class="form-control" value="{{ config.ph_max }}">
            </div>
            <div class="mb-3">
              <label>EC Min:</label>
              <input type="text" name="ec_min" class="form-control" value="{{ config.ec_min }}">
            </div>
            <button class="btn btn-primary" type="submit">Save</button>
          </form>
        </div>
      </div>
    </div>

    <!-- SUMMARY TAB (Aggregated usage) -->
    <div class="tab-pane fade" id="summary">
      <div class="card">
        <div class="card-header">Daily Usage Summary</div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Date</th>
                {% for p in all_pumps %}
                  <th>{{ p }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for day_data in aggregated_data %}
                <tr>
                  <td>{{ day_data.date }}</td>
                  {% for p in all_pumps %}
                    <td>
                      {{ day_data.usage.get(p, 0) }}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Partial snippet in dashboard.html for pH/EC chart -->
<script>
  let phData = {{ ph_data|tojson }};
  // phData is like [ ["2025-04-10 14:05:00", 5.8], ... ]

  // We'll separate labels and values
  let phLabels = phData.map(d => d[0]);
  let phValues = phData.map(d => d[1]);

  let ecData = {{ ec_data|tojson }};
  let ecLabels = ecData.map(d => d[0]);
  let ecValues = ecData.map(d => d[1]);

  let phCtx = document.getElementById("phChart").getContext('2d');
  let phChart = new Chart(phCtx, {
    type: 'line',
    data: {
      labels: phLabels,
      datasets: [{
        label: "pH",
        data: phValues,
        borderColor: 'blue',
        fill: false
      }]
    }
  });

  let ecCtx = document.getElementById("ecChart").getContext('2d');
  let ecChart = new Chart(ecCtx, {
    type: 'line',
    data: {
      labels: ecLabels,
      datasets: [{
        label: "EC",
        data: ecValues,
        borderColor: 'green',
        fill: false
      }]
    }
  });
</script>
</body>
</html>

